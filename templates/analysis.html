{% extends "base.html" %}

{% block content %}
<div class="row mb-3 align-items-center">
    <!-- Título e data -->
    <div class="col-md-8 col-12">
        <h1 class="h2 mb-1">{{ analysis.name }}</h1>
        <p class="text-muted mb-0">
            Criado em {{ analysis.creation_date.strftime('%Y-%m-%d %H:%M') }}
        </p>
    </div>

    <!-- Formulário de upload -->
    <div class="col-md-4 col-12 mt-3 mt-md-0">
        <form method="post"
              action="{{ url_for('append_data', analysis_id=analysis.id) }}"
              enctype="multipart/form-data"
              class="d-flex flex-wrap justify-content-md-end align-items-center gap-2">
            
            <div class="flex-grow-1 flex-md-grow-0">
                <input type="file"
                       name="file"
                       accept=".csv"
                       class="form-control form-control-sm"
                       required>
            </div>
            
            <button type="submit" class="btn btn-primary btn-sm">
                <i class="bi bi-upload me-1"></i> Inserir Novos Dados
            </button>
        </form>
    </div>
</div>



<div class="row g-4">
    <div class="col-12">
        <div class="card stat-card">
            <div class="card-body">
                <h5 class="card-title">Visão Geral do Conjunto de Dados</h5>
                <p>Total de Registros: {{ stats.total_records }}</p>
                <p>Total de Features: {{ stats.total_features }}</p>
            </div>
        </div>
    </div>
</div>
<div class="row g-4 mt-2">
    <div class="col-12">
        <div class="card stat-card">
            <div class="card-body">
                <h5 class="card-title">Análise de Features</h5>
                <form method="get" action="{{ url_for('view_analysis', analysis_id=analysis.id) }}">
                    <select class="form-select feature-select" name="feature" onchange="this.form.submit()">
                        <option value="">Selecione uma feature</option>
                        {% for column in stats.columns %}
                        <option value="{{ column }}" {% if request.args.get('feature') == column %}selected{% endif %}>
                            {{ column }}
                        </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="row g-4 mt-2">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Distribuição</h5>
                {% if feature_stats %}
                <div class="row g-3">
                    <div class="col-12">
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2">Distribuição (Histograma / Scatter)</h6>
                                <img src="data:image/png;base64,{{ feature_stats.images.dist_scatter_png|b64encode }}" class="chart-thumb img-fluid" alt="Distribution and Scatter">
                            </div>
                        </div>
                    </div>

                    <!-- Pie and Bar thumbnails (restored) -->
                    <div class="col-md-6">
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2">Pizza</h6>
                                {% if feature_stats.images.pie_png %}
                                    <img src="data:image/png;base64,{{ feature_stats.images.pie_png|b64encode }}" class="chart-thumb img-fluid" alt="Pie Chart">
                                {% else %}
                                <p class="text-muted">N/A</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2">Bar</h6>
                                {% if feature_stats.images.bar_png %}
                                    <img src="data:image/png;base64,{{ feature_stats.images.bar_png|b64encode }}" class="chart-thumb img-fluid" alt="Bar Chart">
                                {% else %}
                                <p class="text-muted">N/A</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                </div>
                {% else %}
                <p class="text-muted">Selecione uma feature para ver os gráficos</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-3">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Estatísticas</h5>
                {% if feature_stats %}
                <div class="feature-stats">
                    <p>Contagem: {{ feature_stats.stats.count }}</p>
                    <p>Média: {{ "%.2f"|format(feature_stats.stats.mean) if feature_stats.stats.mean else 'N/A' }}</p>
                    <p>Desvio Padrão: {{ "%.2f"|format(feature_stats.stats.std) if feature_stats.stats.std else 'N/A' }}</p>
                    <p>Mínimo: {{ "%.2f"|format(feature_stats.stats['min']) if feature_stats.stats['min'] else 'N/A' }}</p>
                    <p>25%: {{ "%.2f"|format(feature_stats.stats['25%']) if feature_stats.stats['25%'] else 'N/A' }}</p>
                    <p>50% (mediana): {{ "%.2f"|format(feature_stats.stats['50%']) if feature_stats.stats['50%'] else 'N/A' }}</p>
                    <p>75%: {{ "%.2f"|format(feature_stats.stats['75%']) if feature_stats.stats['75%'] else 'N/A' }}</p>
                    <p>Máx: {{ "%.2f"|format(feature_stats.stats['max']) if feature_stats.stats['max'] else 'N/A' }}</p>
                    {% if feature_stats.correlation is not none %}
                    <p>Correlação com o alvo: {{ "%.4f"|format(feature_stats.correlation) }}</p>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-muted">Selecione uma feature para ver as estatísticas</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Interativo</h5>
                {% if feature_stats and feature_stats.interactive_html %}
                <div class="plotly-embed">{{ feature_stats.interactive_html|safe }}</div>
                {% else %}
                <p class="text-muted">Selecione uma feature para ver o gráfico interativo</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4 mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Machine Learning</h5>

                <!-- Formulário de seleção de classificador / hiperparâmetros (GET) -->
                <form action="{{ url_for('train_model', analysis_id=analysis.id) }}" method="get" class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label">Classificador</label>
                        <select name="classifier" id="classifier-select" class="form-select">
                            <option value="random_forest" {% if request.args.get('classifier', 'random_forest') == 'random_forest' %}selected{% endif %}>Random Forest</option>
                            <option value="decision_tree" {% if request.args.get('classifier') == 'decision_tree' %}selected{% endif %}>Decision Tree</option>
                            <option value="knn" {% if request.args.get('classifier') == 'knn' %}selected{% endif %}>K-Nearest Neighbors (KNN)</option>
                            <option value="logistic_regression" {% if request.args.get('classifier') == 'logistic_regression' %}selected{% endif %}>Logistic Regression</option>
                            <option value="svm" {% if request.args.get('classifier') == 'svm' %}selected{% endif %}>SVM</option>
                        </select>
                    </div>

                    <div class="col-md-2 param-group param-rf">
                        <label class="form-label small">n_estimators</label>
                        <input type="number" name="n_estimators" min="1" class="form-control" value="{{ request.args.get('n_estimators', 100) }}">
                    </div>

                    <div class="col-md-2 param-group param-rf param-dt">
                        <label class="form-label small">max_depth</label>
                        <input type="text" name="max_depth" class="form-control" placeholder="None" value="{{ request.args.get('max_depth', '') }}">
                    </div>

                    <div class="col-md-2 param-group param-knn">
                        <label class="form-label small">n_neighbors</label>
                        <input type="number" name="n_neighbors" min="1" class="form-control" value="{{ request.args.get('n_neighbors', 5) }}">
                    </div>

                    <div class="col-md-2 param-group param-lr param-svm">
                        <label class="form-label small">C</label>
                        <input type="text" name="C" class="form-control" value="{{ request.args.get('C', 1.0) }}">
                    </div>

                    <div class="col-md-2 param-group param-lr">
                        <label class="form-label small">max_iter</label>
                        <input type="number" name="max_iter" min="1" class="form-control" value="{{ request.args.get('max_iter', 100) }}">
                    </div>

                    <div class="col-md-3 param-group param-svm">
                        <label class="form-label small">kernel (svm)</label>
                        <input type="text" name="kernel" class="form-control" value="{{ request.args.get('kernel', 'rbf') }}">
                    </div>

                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Treinar Modelo</button>
                        <small class="text-muted ms-2">Os parâmetros são opcionais — deixe em branco para usar valores padrão.</small>
                    </div>
                </form>

                <script>
                    (function(){
                        const select = document.getElementById('classifier-select');
                        const groups = {
                            rf: document.querySelectorAll('.param-rf'),
                            dt: document.querySelectorAll('.param-dt'),
                            knn: document.querySelectorAll('.param-knn'),
                            lr: document.querySelectorAll('.param-lr'),
                            svm: document.querySelectorAll('.param-svm')
                        };

                        function updateVisibility() {
                            const val = select.value;
                            // hide all
                            Object.values(groups).forEach(nlist => nlist.forEach(el => el.style.display = 'none'));
                            // show relevant
                            if (val === 'random_forest') {
                                groups.rf.forEach(el => el.style.display = '');
                            } else if (val === 'decision_tree') {
                                groups.dt.forEach(el => el.style.display = '');
                                // also show max_depth input which overlaps rf/dt in markup
                                document.querySelectorAll('.param-dt').forEach(el => el.style.display = '');
                            } else if (val === 'knn') {
                                groups.knn.forEach(el => el.style.display = '');
                            } else if (val === 'logistic_regression') {
                                groups.lr.forEach(el => el.style.display = '');
                            } else if (val === 'svm') {
                                groups.svm.forEach(el => el.style.display = '');
                            }
                        }

                        select.addEventListener('change', updateVisibility);
                        // initial update
                        updateVisibility();
                    })();
                </script>

            </div>
        </div>
    </div>
</div>
{% endblock %}