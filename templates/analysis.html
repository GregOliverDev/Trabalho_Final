{% extends "base.html" %}

{% block content %}
<div class="row mb-3 align-items-center">
    <div class="col-md-8 col-12">
        <h1 class="h2 mb-1">{{ analysis.name }}</h1>
        <p class="text-muted mb-0">
            Criado em {{ analysis.creation_date.strftime('%Y-%m-%d %H:%M') }}
        </p>
    </div>
    <div class="col-md-4 col-12 mt-3 mt-md-0">
        <form method="post"
              action="{{ url_for('append_data', analysis_id=analysis.id) }}"
              enctype="multipart/form-data"
              class="d-flex flex-wrap justify-content-md-end align-items-center gap-2">
            
            <div class="flex-grow-1 flex-md-grow-0">
                <input type="file"
                       name="file"
                       accept=".csv"
                       class="form-control form-control-sm"
                       required>
            </div>
            
            <button type="submit" class="btn btn-primary btn-sm">
                <i class="bi bi-upload me-1"></i> Inserir Novos Dados
            </button>
        </form>
    </div>
</div>



<div class="row g-4">
    <div class="col-12">
        <div class="card stat-card">
            <div class="card-body">
                <h5 class="card-title">Vis√£o Geral do Conjunto de Dados</h5>
                <p>Total de Registros: {{ stats.total_records }}</p>
                <p>Total de Features: {{ stats.total_features }}</p>
            </div>
        </div>
    </div>
</div>
<div class="row g-4 mt-2">
    <div class="col-12">
        <div class="card stat-card">
            <div class="card-body">
                <h5 class="card-title">An√°lise de Features</h5>
                <form method="get" action="{{ url_for('view_analysis', analysis_id=analysis.id) }}">
                    <select class="form-select feature-select" name="feature" onchange="this.form.submit()">
                        <option value="">Selecione uma feature</option>
                        {% for column in stats.columns %}
                        <option value="{{ column }}" {% if request.args.get('feature') == column %}selected{% endif %}>
                            {{ column }}
                        </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-3">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Estat√≠sticas</h5>
                {% if feature_stats %}
                <div class="feature-stats">
                    <p>Contagem: {{ feature_stats.stats.count }}</p>
                    <p>M√©dia: {{ "%.2f"|format(feature_stats.stats.mean) if feature_stats.stats.mean else 'N/A' }}</p>
                    <p>Desvio Padr√£o: {{ "%.2f"|format(feature_stats.stats.std) if feature_stats.stats.std else 'N/A' }}</p>
                    <p>M√≠nimo: {{ "%.2f"|format(feature_stats.stats['min']) if feature_stats.stats['min'] else 'N/A' }}</p>
                    <p>25%: {{ "%.2f"|format(feature_stats.stats['25%']) if feature_stats.stats['25%'] else 'N/A' }}</p>
                    <p>50% (mediana): {{ "%.2f"|format(feature_stats.stats['50%']) if feature_stats.stats['50%'] else 'N/A' }}</p>
                    <p>75%: {{ "%.2f"|format(feature_stats.stats['75%']) if feature_stats.stats['75%'] else 'N/A' }}</p>
                    <p>M√°x: {{ "%.2f"|format(feature_stats.stats['max']) if feature_stats.stats['max'] else 'N/A' }}</p>
                    {% if feature_stats.correlation is not none %}
                    <p>Correla√ß√£o com o alvo: {{ "%.4f"|format(feature_stats.correlation) }}</p>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-muted">Selecione uma feature para ver as estat√≠sticas</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Interativo</h5>
                {% if feature_stats and feature_stats.interactive_html %}
                <div class="plotly-embed">{{ feature_stats.interactive_html|safe }}</div>
                {% else %}
                <p class="text-muted">Selecione uma feature para ver o gr√°fico interativo</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-2">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Distribui√ß√£o</h5>
                {% if feature_stats %}
                <div class="row g-3">
                    <div class="col-12">
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2">Distribui√ß√£o (Histograma / Scatter)</h6>
                                <img src="data:image/png;base64,{{ feature_stats.images.dist_scatter_png|b64encode }}" class="chart-thumb img-fluid" alt="Distribution and Scatter">
                            </div>
                        </div>
                    </div>

                    <!-- Pie and Bar thumbnails (restored) -->
                    <div class="col-md-6">
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2">Pizza</h6>
                                {% if feature_stats.images.pie_png %}
                                    <img src="data:image/png;base64,{{ feature_stats.images.pie_png|b64encode }}" class="chart-thumb img-fluid" alt="Pie Chart">
                                {% else %}
                                <p class="text-muted">N/A</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2">Bar</h6>
                                {% if feature_stats.images.bar_png %}
                                    <img src="data:image/png;base64,{{ feature_stats.images.bar_png|b64encode }}" class="chart-thumb img-fluid" alt="Bar Chart">
                                {% else %}
                                <p class="text-muted">N/A</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                </div>
                {% else %}
                <p class="text-muted">Selecione uma feature para ver os gr√°ficos</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>




<div class="row g-4 mt-2">
    <div class="col-12">
        <div class="card stat-card">
            <div class="card-body">
                <h5 class="card-title">An√°lises Gerais</h5>

                <!-- Categoriza√ß√£o de Qualidade (est√°tica) -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-light border">
                            <h6 class="mb-3">
                                <i class="bi bi-star-fill me-2 text-warning"></i>Categoriza√ß√£o de Qualidade dos Vinhos
                            </h6>
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="p-2">
                                        <span class="badge bg-success fs-6 px-3 py-2">üü¢ ALTA ‚â• 7</span>
                                        <p class="mt-2 mb-0 small text-muted">Vinhos de qualidade superior</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-2">
                                        <span class="badge bg-warning fs-6 px-3 py-2">üü° M√âDIA 5-6</span>
                                        <p class="mt-2 mb-0 small text-muted">Vinhos de qualidade padr√£o</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-2">
                                        <span class="badge bg-danger fs-6 px-3 py-2">üî¥ BAIXA < 5</span>
                                        <p class="mt-2 mb-0 small text-muted">Vinhos de qualidade inferior</p>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    <strong>Interpreta√ß√£o:</strong> Esta categoriza√ß√£o ajuda a identificar padr√µes entre 
                                    as caracter√≠sticas qu√≠micas dos vinhos e sua qualidade percebida pelos especialistas.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Tabela de Correla√ß√µes com Target -->
                    <div class="col-md-6">
                        <h6 class="card-subtitle mb-3">Correla√ß√µes com {{ analysis.target_feature }}</h6>
                        {% if target_correlations is not none %}
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Feature</th>
                                            <th>Correla√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for feature, correlation in target_correlations.items() %}
                                        <tr>
                                            <td>{{ feature }}</td>
                                            <td>
                                                <span class="badge {% if correlation > 0.5 %}bg-success{% elif correlation > 0.2 %}bg-danger{% elif correlation < -0.2 %}bg-primary{% elif correlation < -0.5 %}bg-dark{% else %}bg-secondary{% endif %}">
                                                    {{ "%.6f"|format(correlation) }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-muted mt-2 small">
                                <strong>Cores:</strong> 
                                <span class="badge bg-success">Verde > 0.5</span>
                                <span class="badge bg-danger">Vermelho > 0.2</span>
                                <span class="badge bg-secondary">Cinza ‚âà 0</span>
                                <span class="badge bg-primary">Azul < -0.2</span>
                                <span class="badge bg-dark">Preto < -0.5</span>
                            </p>
                        {% else %}
                            <p class="text-muted">N√£o foi poss√≠vel calcular as correla√ß√µes com a vari√°vel target.</p>
                        {% endif %}
                    </div>

                    <!-- Mapa de Correla√ß√£o HEATMAP -->
                    <div class="col-md-6">
                        <h6 class="card-subtitle mb-3">Mapa de Correla√ß√£o HEATMAP</h6>
                        {% if heatmap_plot %}
                            <div class="text-center">
                                <img src="data:image/png;base64,{{ heatmap_plot|b64encode }}" 
                                     class="img-fluid" 
                                     alt="Correlation Heatmap"
                                     style="max-height: 500px;">
                            </div>
                            <p class="text-muted mt-2 small">
                                <strong>Interpreta√ß√£o:</strong> Valores pr√≥ximos a 1 (vermelho) indicam correla√ß√£o positiva forte, 
                                valores pr√≥ximos a -1 (azul) indicam correla√ß√£o negativa forte, e valores pr√≥ximos a 0 (branco) 
                                indicam pouca ou nenhuma correla√ß√£o linear.
                            </p>
                        {% else %}
                            <p class="text-muted">N√£o foi poss√≠vel gerar o mapa de correla√ß√£o. Verifique se o dataset possui features num√©ricas suficientes.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4 mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Machine Learning</h5>
                <form action="{{ url_for('train_model', analysis_id=analysis.id) }}" method="get" class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label">Classificador</label>
                        <select name="classifier" id="classifier-select" class="form-select">
                            <option value="random_forest" {% if request.args.get('classifier', 'random_forest') == 'random_forest' %}selected{% endif %}>Random Forest</option>
                            <option value="decision_tree" {% if request.args.get('classifier') == 'decision_tree' %}selected{% endif %}>Decision Tree</option>
                            <option value="knn" {% if request.args.get('classifier') == 'knn' %}selected{% endif %}>K-Nearest Neighbors (KNN)</option>
                            <option value="logistic_regression" {% if request.args.get('classifier') == 'logistic_regression' %}selected{% endif %}>Logistic Regression</option>
                            <option value="svm" {% if request.args.get('classifier') == 'svm' %}selected{% endif %}>SVM</option>
                        </select>
                    </div>

                    <div class="col-md-2 param-group param-rf">
                        <label class="form-label small">n_estimators</label>
                        <input type="number" name="n_estimators" min="1" class="form-control" value="{{ request.args.get('n_estimators', 100) }}">
                    </div>

                    <div class="col-md-2 param-group param-rf param-dt">
                        <label class="form-label small">max_depth</label>
                        <input type="text" name="max_depth" class="form-control" placeholder="None" value="{{ request.args.get('max_depth', '') }}">
                    </div>

                    <div class="col-md-2 param-group param-knn">
                        <label class="form-label small">n_neighbors</label>
                        <input type="number" name="n_neighbors" min="1" class="form-control" value="{{ request.args.get('n_neighbors', 5) }}">
                    </div>

                    <div class="col-md-2 param-group param-lr param-svm">
                        <label class="form-label small">C</label>
                        <input type="text" name="C" class="form-control" value="{{ request.args.get('C', 1.0) }}">
                    </div>

                    <div class="col-md-2 param-group param-lr">
                        <label class="form-label small">max_iter</label>
                        <input type="number" name="max_iter" min="1" class="form-control" value="{{ request.args.get('max_iter', 100) }}">
                    </div>

                    <div class="col-md-3 param-group param-svm">
                        <label class="form-label small">kernel (svm)</label>
                        <input type="text" name="kernel" class="form-control" value="{{ request.args.get('kernel', 'rbf') }}">
                    </div>

                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Treinar Modelo</button>
                        <small class="text-muted ms-2">Os par√¢metros s√£o opcionais ‚Äî deixe em branco para usar valores padr√£o.</small>
                    </div>
                </form>

                <script>
                    (function(){
                        const select = document.getElementById('classifier-select');
                        const groups = {
                            rf: document.querySelectorAll('.param-rf'),
                            dt: document.querySelectorAll('.param-dt'),
                            knn: document.querySelectorAll('.param-knn'),
                            lr: document.querySelectorAll('.param-lr'),
                            svm: document.querySelectorAll('.param-svm')
                        };

                        function updateVisibility() {
                            const val = select.value;
                            // hide all
                            Object.values(groups).forEach(nlist => nlist.forEach(el => el.style.display = 'none'));
                            // show relevant
                            if (val === 'random_forest') {
                                groups.rf.forEach(el => el.style.display = '');
                            } else if (val === 'decision_tree') {
                                groups.dt.forEach(el => el.style.display = '');
                                // also show max_depth input which overlaps rf/dt in markup
                                document.querySelectorAll('.param-dt').forEach(el => el.style.display = '');
                            } else if (val === 'knn') {
                                groups.knn.forEach(el => el.style.display = '');
                            } else if (val === 'logistic_regression') {
                                groups.lr.forEach(el => el.style.display = '');
                            } else if (val === 'svm') {
                                groups.svm.forEach(el => el.style.display = '');
                            }
                        }

                        select.addEventListener('change', updateVisibility);
                        // initial update
                        updateVisibility();
                    })();
                </script>

            </div>
        </div>
    </div>
</div>
{% endblock %}